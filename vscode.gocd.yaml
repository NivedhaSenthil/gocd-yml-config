pipelines:
  VSCode-Build:
    group: IDE_Plugins
    materials:
      gauge-vscode:
        git: https://github.com/getgauge/gauge-vscode.git
        shallow_clone: true
    stages:
      - build:
          jobs:
            build:
              elastic_profile_id: debian-node-xvfb
              environment_variables:
                GAUGE_ROOT: /tmp
              tasks:
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm -v
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm run build
              artifacts:
                - build:
                    source: gauge-*.vsix
                    destination: artifacts
                - build:
                    source: "*"
                    destination: gauge-vscode
  VSCode-Tests:
    group: IDE_Plugins
    materials:
      vscode-build:
        pipeline: VSCode-Build
        stage: build
      gauge-package:
        pipeline: Gauge-Build
        stage: windows
    stages:
      - test:
          jobs:
            linux:
              elastic_profile_id: debian-node-xvfb
              environment_variables:
                GAUGE_ROOT: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    source: test_installers/gauge-linux.x86_64.zip
                    is_file: yes
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_ROOT/bin && unzip -o gauge-darwin.x86_64.zip -d $GAUGE_ROOT/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=$GAUGE_ROOT/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ($GAUGE_ROOT/bin/gauge install js && $GAUGE_ROOT/bin/gauge install html-report && $GAUGE_ROOT/bin/gauge version)
                - fetch:
                    pipeline: VSCode-Build
                    stage: build
                    job: build
                    source: gauge-vscode
                - exec:
                    working_directory: gauge-vscode
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    working_directory: gauge-vscode
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm run build && PATH=/tmp:$PATH xvfb-run npm test
            darwin:
              resources:
                - FT
                - darwin
              environment_variables:
                GAUGE_ROOT: /tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    source: test_installers/gauge-darwin.x86_64.zip
                    is_file: yes
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - mkdir -p $GAUGE_ROOT/bin && unzip -o gauge-darwin.x86_64.zip -d $GAUGE_ROOT/bin
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - PATH=$GAUGE_ROOT/bin:$PATH gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master
                - exec:
                    command: /bin/sh
                    arguments:
                      - -c
                      - ($GAUGE_ROOT/bin/gauge install js && $GAUGE_ROOT/bin/gauge install html-report && $GAUGE_ROOT/bin/gauge version)
                - fetch:
                    pipeline: VSCode-Build
                    stage: build
                    job: build
                    source: gauge-vscode
                - exec:
                    working_directory: gauge-vscode
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm install
                - exec:
                    working_directory: gauge-vscode
                    command: /bin/sh
                    arguments:
                      - -c
                      - npm run build && PATH=/tmp:$PATH xvfb-run npm test
                - exec:
                    run_if: any
                    command: touch
                    arguments:
                    - /vagrant/rollback.txt
            windows:
              elastic_profile_id: windows-all
              environment_variables:
                GAUGE_ROOT: C:\tmp
              tasks:
                - fetch:
                    pipeline: Gauge-Build
                    stage: windows
                    job: sign
                    source: test_installers/gauge-windows.x86_64.zip
                    is_file: yes
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - unzip -o gauge-windows.x86_64.zip -d %GAUGE_ROOT%
                - exec:
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%\\gauge config gauge_repository_url https://raw.githubusercontent.com/getgauge/gauge-nightly-repository/master"
                - exec:
                    working_directory: gauge-tests
                    command: cmd
                    arguments:
                      - /c
                      - "%GAUGE_ROOT%\\gauge install js && %GAUGE_ROOT%\\gauge install html-report && %GAUGE_ROOT%\\gauge version"
                - fetch:
                    pipeline: VSCode-Build
                    stage: build
                    job: build
                    source: gauge-vscode
                - exec:
                    working_directory: gauge-vscode
                    command: cmd
                    arguments:
                      - /c
                      - npm install & npm run build
                - exec:
                    working_directory: gauge-vscode
                    command: cmd
                    arguments:
                      - /c
                      - path %GAUGE_ROOT%;%PATH% & npm test
